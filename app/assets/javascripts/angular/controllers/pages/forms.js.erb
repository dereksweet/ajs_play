var moduleName = "formsApp";

var formsApp = angular.module(moduleName, []);

var mySimpleFormsCtrl = function ($scope, dataStoreService, dataShareService) {
  $scope.user = {
    first_name: "",
    email: "",
    color: "",
    is_cool: true
  };
  $scope.colors = dataShareService.colors;

  reset_messages = function () {
    $scope.showSubmitSuccessMessage = false;
    $scope.showSubmitErrorMessage = false;
    $scope.showLoadSuccessMessage = false;
    $scope.showLoadErrorMessage = false;
  };

  $scope.get_user = function () {
    reset_messages();

    var promise = dataStoreService.getUser($scope.user.first_name);

    promise.success(function (user, status) {
      if (user) {
        $scope.user.email = user.email;
        $scope.user.color = user.color;
        $scope.user.is_cool = user.is_cool;

        $scope.sampleForm.email.$setDirty();
        $scope.sampleForm.color.$setDirty();
        $scope.sampleForm.is_cool.$setDirty();

        $scope.showLoadSuccessMessage = true;
      }
      else {
        $scope.showLoadErrorMessage = true;
      }
    });

    promise.error(function (data, status) {
      $scope.showLoadErrorMessage = true;
      $('#load_error_message').html('(' + status + ')');
    });
  };

  $scope.submit_form = function() {
    reset_messages();

    $scope.firstNameInvalid = false;
    $scope.emailInvalid = false;
    $scope.colorInvalid = false;

    if ($scope.sampleForm.first_name.$invalid){
      $scope.firstNameInvalid = true;
    }

    if ($scope.sampleForm.email.$invalid){
      $scope.emailInvalid = true;
    }

    if ($scope.sampleForm.color.$invalid){
      $scope.colorInvalid = true;
    }

    if ($scope.sampleForm.$valid) {
      var promise = dataStoreService.saveUser($scope.user);

      promise.success(function (data, status) {
        $scope.showSubmitSuccessMessage = true;
        dataShareService.get_all_users();
      });

      promise.error(function (data, status) {
        $scope.showSubmitErrorMessage = true;
        $('#submit_error_message').html('(' + status + ')');
      });
    }
  }
};
mySimpleFormsCtrl.$inject = ['$scope', 'dataStoreService', 'dataShareService'];
formsApp.controller('mySimpleFormsCtrl', mySimpleFormsCtrl);


myModalFormsCtrl = function ($scope, dataStoreService, dataShareService) {
  $scope.user_form = {};
  $scope.form_template = '<%= asset_path('pages/forms/form.html') %>';
  $scope.colors = dataShareService.colors;
  modal = $('#modal__form');

  $scope.$on('get_all_users', function() {
    $scope.get_all_users();
  });

  $scope.get_all_users = function () {
    var promise = dataStoreService.getAllUsers();

    promise.success(function (users, status) {
      if (users) {
        $scope.users = users;
      }
      else {
        alert('Error')
      }
    });

    promise.error(function (data, status) {
        alert('Error Communicating');
    });
  };

  $scope.openModal = function() {
    modal.foundation('reveal', 'open');
  };

  $scope.closeModal = function() {
    modal.foundation('reveal', 'close');
  };

  $scope.edit_user = function(first_name) {
    var promise = dataStoreService.getUser(first_name);

    promise.success(function (user, status) {
      if (user) {
        $scope.user_form.first_name = first_name;
        $scope.user_form.email = user.email;
        $scope.user_form.color = user.color;
        $scope.user_form.is_cool = user.is_cool;
        $scope.openModal();
      }
      else {
        alert('Error - no Data')
      }
    });

    promise.error(function (data, status) {
      alert('Error Communicating - ' + status);
    });
  };

  $scope.update_user = function() {
    var user = {
      first_name: $scope.user_form.first_name,
      email: $scope.user_form.email,
      color: $scope.user_form.color,
      is_cool: $scope.user_form.is_cool
    };
    var promise = dataStoreService.saveUser(user);

    promise.success(function (data, status) {
      if (data) {
        $scope.closeModal();
        $scope.get_all_users();
      }
      else {
        alert('Error - no Data')
      }
    });

    promise.error(function (data, status) {
      alert('Error Communicating - ' + status);
    });
  };

  $scope.delete_user = function() {
    var promise = dataStoreService.deleteUser($scope.user_form.first_name);

    promise.success(function (data, status) {
      $scope.closeModal();
      $scope.get_all_data();
    });

    promise.error(function (data, status) {
      alert('Error Communicating - ' + status);
    });
  };
};
myModalFormsCtrl.$inject = ['$scope', 'dataStoreService', 'dataShareService'];
formsApp.controller('myModalFormsCtrl', myModalFormsCtrl);
