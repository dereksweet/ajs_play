var formsApp = angular.module("formsApp", []);

formsApp.factory('dataStoreService', function ($http) {
    var dataStore = {};

    dataStore.saveDatum = function (theData) {
        return $http({ method: 'POST', url: 'api/save_datum', data: theData });
    };

    dataStore.getDatum = function (first_name) {
        return $http({ method: 'GET', url: 'api/get_datum?first_name=' + first_name });
    };

    dataStore.deleteDatum = function (first_name) {
        return $http({ method: 'DELETE', url: 'api/delete_datum?first_name=' + first_name });
    };

    dataStore.getAllData = function () {
        return $http({ method: 'GET', url: 'api/get_all_data' });
    };

    return dataStore;
});

formsApp.controller('MyFormsCtrl', function ($scope, dataStoreService) {
    var myData = {
        first_name: "",
        email: "",
        color: "",
        is_cool: true
    };
    $scope.data = myData;

    $scope.colors = [
        { value: "red", label: "Red" },
        { value: "blue", label: "Blue" },
        { value: "yellow", label: "Yellow" }
    ];

    $scope.datum_form = {};
    $scope.form_template = '<%= asset_path('pages/forms/form.html') %>';
    modal = $('#modal__form');

    reset_messages = function() {
        $scope.showSubmitSuccessMessage = false;
        $scope.showSubmitErrorMessage = false;
        $scope.showLoadSuccessMessage = false;
        $scope.showLoadErrorMessage = false;
    }

    $scope.get_data = function() {
        reset_messages();

        var promise = dataStoreService.getDatum($scope.data.first_name);

        promise.success(function (data, status) {
            if (data) {
                $scope.data.email = data.email;
                $scope.data.color = data.color;
                $scope.data.is_cool = data.is_cool;

                $scope.sampleForm.email.$setDirty();
                $scope.sampleForm.color.$setDirty();
                $scope.sampleForm.is_cool.$setDirty();

                $scope.showLoadSuccessMessage = true;
            }
            else {
                $scope.showLoadErrorMessage = true;
            }
        });

        promise.error(function (data, status) {
            $scope.showLoadErrorMessage = true;
            $('#load_error_message').html('(' + status + ')');
        });
    };

    $scope.get_all_data = function () {
        var promise = dataStoreService.getAllData();

        promise.success(function (data, status) {
            if (data) {
                $scope.sample_data = data;
            }
            else {
                alert('Error')
            }

        });

        promise.error(function (data, status) {
            alert('Error Communicating');
        });
    };

    $scope.openModal = function() {
        modal.foundation('reveal', 'open');
    };

    $scope.closeModal = function() {
        modal.foundation('reveal', 'close');
    };

    $scope.edit_datum = function(first_name) {
        var promise = dataStoreService.getDatum(first_name);

        promise.success(function (data, status) {
            if (data) {
                $scope.datum_form.first_name = first_name;
                $scope.datum_form.email = data.email;
                $scope.datum_form.color = data.color;
                $scope.datum_form.is_cool = data.is_cool;
                $scope.openModal();
            }
            else {
                alert('Error - no Data')
            }

        });

        promise.error(function (data, status) {
            alert('Error Communicating - ' + status);
        });
    };

    $scope.update_datum = function() {
        var theData = {
            first_name: $scope.datum_form.first_name,
            email: $scope.datum_form.email,
            color: $scope.datum_form.color,
            is_cool: $scope.datum_form.is_cool
        };
        var promise = dataStoreService.saveDatum(theData);

        promise.success(function (data, status) {
            if (data) {
                $scope.closeModal();
                $scope.get_all_data();
            }
            else {
                alert('Error - no Data')
            }

        });

        promise.error(function (data, status) {
            alert('Error Communicating - ' + status);
        });
    };

    $scope.delete_datum = function() {
        var promise = dataStoreService.deleteDatum($scope.datum_form.first_name);

        promise.success(function (data, status) {
            $scope.closeModal();
            $scope.get_all_data();
        });

        promise.error(function (data, status) {
            alert('Error Communicating - ' + status);
        });
    };

    $scope.submit_form = function() {
        reset_messages();

        $scope.firstNameInvalid = false;
        $scope.emailInvalid = false;
        $scope.colorInvalid = false;

        if ($scope.sampleForm.first_name.$invalid){
            $scope.firstNameInvalid = true;
        }

        if ($scope.sampleForm.email.$invalid){
            $scope.emailInvalid = true;
        }

        if ($scope.sampleForm.color.$invalid){
            $scope.colorInvalid = true;
        }

        if ($scope.sampleForm.$valid) {
            var promise = dataStoreService.saveDatum($scope.data);

            promise.success(function (data, status) {
                $scope.showSubmitSuccessMessage = true;
                $scope.get_all_data();
            });

            promise.error(function (data, status) {
                $scope.showSubmitErrorMessage = true;
                $('#submit_error_message').html('(' + status + ')');
            });
        }
    }
});
