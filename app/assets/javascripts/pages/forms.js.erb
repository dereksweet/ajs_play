var formsApp = angular.module("formsApp", []);

formsApp.factory('dataStoreService', function ($http) {
    var dataStore = {};

    dataStore.doSubmit = function (theData) {
        return $http({ method: 'POST', url: 'api/save_data', data: theData });
    };

    dataStore.loadData = function (first_name) {
        return $http({ method: 'GET', url: 'api/get_data?first_name=' + first_name })
    };

    return dataStore;
});

formsApp.controller('MyFormsCtrl', function ($scope, dataStoreService) {
    var myData = {
        first_name: "",
        email: "",
        color: "",
        is_cool: true
    };
    $scope.data = myData;

    $scope.colors = [
        { value: "red", label: "Red" },
        { value: "blue", label: "Blue" },
        { value: "yellow", label: "Yellow" }
    ];

    reset_messages = function() {
        $scope.showSubmitSuccessMessage = false;
        $scope.showSubmitErrorMessage = false;
        $scope.showLoadSuccessMessage = false;
        $scope.showLoadErrorMessage = false;
    }

    $scope.get_data = function() {
        reset_messages();

        var promise = dataStoreService.loadData($scope.data.first_name);

        promise.success(function (data, status) {
            if (data) {
                $scope.data.email = data.email;
                $scope.data.color = data.color;
                $scope.data.is_cool = data.is_cool;

                $scope.sampleForm.email.$setDirty();
                $scope.sampleForm.color.$setDirty();
                $scope.sampleForm.is_cool.$setDirty();

                $scope.showLoadSuccessMessage = true;
            }
            else {
                $scope.showLoadErrorMessage = true;
            }
        });

        promise.error(function (data, status) {
            $scope.showLoadErrorMessage = true;
            $('#load_error_message').html('(' + status + ')');
        });
    }

    $scope.submit_form = function() {
        reset_messages();

        $scope.firstNameInvalid = false;
        $scope.emailInvalid = false;
        $scope.colorInvalid = false;

        if ($scope.sampleForm.first_name.$invalid){
            $scope.firstNameInvalid = true;
        }

        if ($scope.sampleForm.email.$invalid){
            $scope.emailInvalid = true;
        }

        if ($scope.sampleForm.color.$invalid){
            $scope.colorInvalid = true;
        }

        if ($scope.sampleForm.$valid) {
            var promise = dataStoreService.doSubmit($scope.data);

            promise.success(function (data, status) {
                $scope.showSubmitSuccessMessage = true;
            });

            promise.error(function (data, status) {
                $scope.showSubmitErrorMessage = true;
                $('#submit_error_message').html('(' + status + ')');
            });
        }
    }
});
